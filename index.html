<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BHOLA NATH BASAK</title>
<style>
/* (kept your styles — unchanged except small layout spacing) */
body {margin:0; font-family: Arial, sans-serif; background:linear-gradient(to right,#1a2a6c,#b21f1f,#fdbb2d); color:white; line-height:1.6;}
header{text-align:center; padding:20px; background:rgba(0,0,0,0.6);}
header img{width:180px;height:180px;object-fit:cover;border-radius:50%;border:5px solid #fff;transition: transform 0.4s;}
header img:hover{transform: scale(1.05) rotate(2deg);}
header h1{margin:15px 0 0; font-size:2.5em;color:#fbd46d;text-shadow:2px 2px 5px black;}
nav{display:flex;justify-content:center;background:rgba(0,0,0,0.8);flex-wrap:wrap;align-items:center;}
nav a{color:white;text-decoration:none;padding:10px 15px;display:block;transition:background 0.3s,color 0.3s;cursor:pointer;}
nav a:hover{background:#fbd46d;color:black;border-radius:5px;}
#statusSearch {margin-left:10px;padding:5px;border-radius:5px;border:none;}
#statusResult {margin-left:10px;}
section{padding:40px 20px;max-width:900px;margin:auto;background:rgba(255,255,255,0.1);margin-bottom:30px;border-radius:12px;box-shadow:0px 4px 15px rgba(0,0,0,0.5);}
section h2{color:#ffe66d;margin-bottom:15px;}
.form-box{background:rgba(0,0,0,0.7);padding:20px;border-radius:12px;color:white;max-width:500px;margin:auto;}
.form-box label{display:block;margin-bottom:10px;}
.form-box input, .form-box select, .form-box textarea{width:100%;padding:5px;margin-top:3px;border-radius:5px;border:none;}
.btn{background:#fbd46d;color:black;padding:8px 12px;border:none;border-radius:5px;cursor:pointer;margin-top:10px;}
.btn:hover{background:white;}
table{width:100%;border-collapse:collapse;color:black;background:white;margin-top:20px;}
table, th, td{border:1px solid #000;}
th, td{padding:8px;text-align:center;}
.green{background:#28a745;color:white;}
.red{background:#dc3545;color:white;}
.pink{background:#ff69b4;color:white;}
.hidden{display:none;}
.social-box{background:#333;padding:15px;margin:20px auto;border-radius:12px;max-width:400px;text-align:center;}
.social-box h3{margin-bottom:10px;color:#fbd46d;}
.social-box a{margin:0 10px;color:white;text-decoration:none;font-weight:bold;}
@media (max-width: 600px) {
  .form-box input, .form-box select, .form-box button, .form-box textarea {width:100% !important; font-size:16px; margin-top:5px;}
  nav {flex-direction: column; align-items: flex-start;}
  #statusSearch {width:90%; margin:10px;}
}
</style>
</head>
<body>

<header>
  <img src="myphoto.jpg" alt="Bhola Nath Basak Photo" />
  <h1>BHOLA NATH BASAK</h1>
</header>

<nav>
  <a onclick="showSection('profile')">Profile</a>
  <a onclick="showSection('education')">Education</a>
  <a onclick="showSection('culture')">Culture</a>
  <a onclick="showSection('achievements')">Achievements</a>
  <a onclick="showSection('hobbies')">Hobbies</a>
  <a onclick="showSection('interested')">Interested About</a>
  <a onclick="showSection('thoughts')">Thoughts</a>
  <a onclick="showSection('visitor')">Visitor Form</a>
  <a onclick="showSection('adminLogin')">Admin Login</a>
  <input id="statusSearch" type="text" placeholder="Visitor Status: Enter Appt No" onkeypress="if(event.key==='Enter'){checkStatus();}" />
</nav>

<div id="statusResult"></div>

<!-- Profile -->
<section id="profile"><h2>Profile</h2><p>I am BHOLA NATH BASAK, a passionate learner and explorer of life’s endless opportunities. I aim to inspire others while growing myself in every possible field.</p></section>
<section id="education"><h2>Education</h2><p>Education is the foundation of growth. I gather knowledge from books and real-life experiences shaping problem-solving abilities.</p></section>
<section id="culture"><h2>Culture</h2><p>I embrace traditions, values, and respect for diversity while blending it with modern ideas for a balanced lifestyle.</p></section>
<section id="achievements"><h2>Achievements</h2><p>Every step of life is an achievement — from personal milestones to professional success, reflecting perseverance, hard work, and dedication.</p></section>
<section id="hobbies"><h2>Hobbies</h2><p>I enjoy creative and recreational activities — sports, art, music, technology. Hobbies give me balance and energy.</p></section>
<section id="interested"><h2>Interested About</h2><p>Deeply interested in innovation, leadership, and cultural understanding. Exploring new ideas and connecting with people excites me.</p></section>
<section id="thoughts"><h2>Thoughts</h2><p>“Life is not about waiting for opportunities, it is about creating them.” Determination and honesty make anything possible.</p></section>

<!-- Visitor Form (full-screen style) -->
<section id="visitor" class="hidden" style="background:#1a2a6c;padding:40px;">
  <h2>E_Appointment Visitor Form</h2>
  <form id="appointmentForm" class="form-box">
    <label>Name* <input id="Name" name="Name" type="text" required /></label>
    <label>Address <input id="Address" name="Address" type="text" /></label>
    <label>Date of Birth <input id="DateOfBirth" name="Date Of Birth" type="date" /></label>
    <label>Country <input id="Country" name="Country" type="text" /></label>
    <label>Father's Name <input id="FathersName" name="Father's Name" type="text" /></label>
    <label>Visit Date* <input id="VisitDate" name="Visit Date" type="date" required /></label>
    <label>Visit Time* <input id="VisitTime" name="Visit Time" type="time" required /></label>
    <label>Phone Number* <input id="PhoneNumber" name="Phone Number" type="tel" required /></label>
    <label>Email ID* <input id="EmailID" name="Email ID" type="email" required /></label>
    <label>Passport (If Available) <input id="Passport" name="Passport (If Available)" type="text" /></label>
    <label>Purpose <textarea id="Purpose" name="Purpose"></textarea></label>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <button type="submit" class="btn">Submit</button>
      <button type="button" class="btn" onclick="cancelVisitorForm()">Cancel</button>
    </div>
  </form>
  <div id="responseMessage" style="display:none;margin-top:10px;padding:10px;border-radius:5px;"></div>
</section>

<!-- Admin Login -->
<section id="adminLogin" class="hidden">
  <h2>Admin Login</h2>
  <div class="form-box">
    <label>Username <input id="adminUser" type="text" /></label>
    <label>Password <input id="adminPass" type="password" /></label>
    <button class="btn" onclick="adminLogin()">Login</button>
  </div>
</section>

<!-- Admin Dashboard -->
<section id="adminDashboard" class="hidden">
  <h2>Admin Dashboard</h2>
  <div style="margin-bottom:10px"><button class="btn" onclick="adminLogout()">Logout</button></div>
  <table id="visitorTable">
    <thead>
      <tr>
        <th>Appointment Number</th><th>Name</th><th>Address</th><th>Date Of Birth</th>
        <th>Country</th><th>Father's Name</th><th>Visit Date</th><th>Visit Time</th>
        <th>Phone Number</th><th>Email ID</th><th>Passport (If Available)</th><th>Purpose</th>
        <th>Status</th><th>Submitted</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- Communications -->
<div class="social-box">
  <h3>COMMUNICATIONS</h3>
  <a href="#" target="_blank">Facebook</a>
  <a href="#" target="_blank">Instagram</a>
  <a href="#" target="_blank">LinkedIn</a>
  <a href="tel:+1234567890">Phone</a>
</div>

<footer>
  <p>© 2025 BHOLA NATH BASAK | Personal Biography Website</p>
</footer>

<script>
/*
  FINAL: Full front-end logic.
  Replace SCRIPT_URL with your Apps Script web app URL if different.
*/
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxabjEMeIHXJiw8jDVINmPJ59FcdfP_q_6mAgD84aI4Umh1EAbyIqR1g72i0hCzNh-3/exec";

// Ensure initial view
showSection('profile');

// showSection safely defined before any clicks (function is global)
function showSection(id){
  document.querySelectorAll("section").forEach(s=>s.classList.add("hidden"));
  const el = document.getElementById(id);
  if(el) el.classList.remove("hidden");
  // scroll to top on section change
  window.scrollTo({top:0,behavior:'smooth'});
}

// Cancel visitor form: reset & go to home (profile)
function cancelVisitorForm(){
  document.getElementById('appointmentForm').reset();
  showSection('profile');
}

// Submit visitor form -> send to Apps Script with action=submit
document.getElementById("appointmentForm").addEventListener("submit", function(e){
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);
  const params = new URLSearchParams();
  formData.forEach((v,k)=>params.append(k,v));
  params.append("action","submit");

  fetch(SCRIPT_URL, { method: "POST", body: params })
    .then(r=>r.json())
    .then(resp=>{
      const msg = document.getElementById("responseMessage");
      if(resp && resp.success){
        msg.innerHTML = "✅ Appointment submitted successfully. Your Appt No: <strong>" + resp.apptNo + "</strong>";
        msg.style.background = "#28a745";
        msg.style.color = "white";
        msg.style.display = "block";
        // Print the appointment details (print popup)
        printAppointmentPopup(resp);
        form.reset();
      } else {
        msg.innerHTML = "❌ Submission failed. Please try again.";
        msg.style.background = "#dc3545";
        msg.style.display = "block";
      }
    })
    .catch(err=>{
      const msg = document.getElementById("responseMessage");
      msg.innerHTML = "❌ Submission error: " + err.message;
      msg.style.background = "#dc3545";
      msg.style.display = "block";
    });
});

// Admin login (hardcoded credentials as before)
function adminLogin(){
  const u = document.getElementById("adminUser").value.trim();
  const p = document.getElementById("adminPass").value.trim();
  // you can change credentials here
  if(u === "admin" && p === "1234"){
    showSection('adminDashboard');
    loadVisitors(); // load persisted visitors from sheet
  } else {
    alert("Invalid username or password");
  }
}
function adminLogout(){
  document.getElementById("adminUser").value = "";
  document.getElementById("adminPass").value = "";
  showSection('profile');
}

// Load visitors (GET main endpoint returns array)
function loadVisitors(){
  const tbody = document.querySelector("#visitorTable tbody");
  tbody.innerHTML = "<tr><td colspan='15'>Loading...</td></tr>";
  fetch(SCRIPT_URL)
    .then(r=>r.json())
    .then(data=>{
      tbody.innerHTML = "";
      if(!Array.isArray(data) || data.length === 0){
        tbody.innerHTML = "<tr><td colspan='15'>No visitors found.</td></tr>";
        return;
      }
      data.forEach(row => {
        // Format Visit Date -> DD-MM-YYYY if possible
        let visitDateStr = row["Visit Date"] || "";
        let formattedVisitDate = visitDateStr;
        try {
          const d = new Date(visitDateStr);
          if(!isNaN(d)) formattedVisitDate = String(d.getDate()).padStart(2,'0') + "-" + String(d.getMonth()+1).padStart(2,'0') + "-" + d.getFullYear();
        } catch(e){ /* leave as is */ }

        const tr = document.createElement('tr');
        tr.id = row["Appointment Number"];
        // status-based class
        const statusClass = (row.Status === "Accepted" || row.Status === "Accept") ? "green" : (row.Status === "Rejected" || row.Status === "Reject") ? "red" : "pink";
        tr.className = statusClass;

        tr.innerHTML = `
          <td>${escapeHtml(row["Appointment Number"]||"")}</td>
          <td>${escapeHtml(row.Name||"")}</td>
          <td>${escapeHtml(row.Address||"")}</td>
          <td>${escapeHtml(row["Date Of Birth"]||"")}</td>
          <td>${escapeHtml(row.Country||"")}</td>
          <td>${escapeHtml(row["Father's Name"]||"")}</td>
          <td>${escapeHtml(formattedVisitDate)}</td>
          <td>${escapeHtml((row["Visit Time"]||"").slice(0,5))}</td>
          <td>${escapeHtml(row["Phone Number"]||"")}</td>
          <td>${escapeHtml(row["Email ID"]||"")}</td>
          <td>${escapeHtml(row["Passport (If Available)"]||"")}</td>
          <td>${escapeHtml(row.Purpose||"")}</td>
          <td>${escapeHtml(row.Status||"Pending")}</td>
          <td>${escapeHtml(row.Submitted||"")}</td>
          <td>
            <button class="btn accept-btn" onclick="changeStatusPersist('${encodeURIComponent(row['Appointment Number'])}','Accepted')" ${row.Status && row.Status !== "Pending" ? "disabled" : ""}>Accept</button>
            <button class="btn reject-btn" onclick="changeStatusPersist('${encodeURIComponent(row['Appointment Number'])}','Rejected')" ${row.Status && row.Status !== "Pending" ? "disabled" : ""}>Reject</button>
            <button class="btn delete-btn" onclick="deleteVisitorPersist('${encodeURIComponent(row['Appointment Number'])}')">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    })
    .catch(err=>{
      tbody.innerHTML = "<tr><td colspan='15'>Error loading visitors: "+escapeHtml(err.message)+"</td></tr>";
    });
}

// Persistent status change: Accept / Reject
function changeStatusPersist(encodedApptNo, newStatus){
  const apptNo = decodeURIComponent(encodedApptNo);
  if(!confirm("Set status to '"+newStatus+"' for "+apptNo+" ?")) return;
  const params = new URLSearchParams();
  params.append("action","status");
  params.append("apptNo", apptNo);
  params.append("status", newStatus);
  fetch(SCRIPT_URL, { method: "POST", body: params })
    .then(r=>r.json())
    .then(res=>{
      if(res && res.success){
        // reload table to reflect persisted state
        loadVisitors();
      } else {
        alert("Failed to update status");
      }
    })
    .catch(err=>{
      alert("Error updating status: "+err.message);
    });
}

// Persistent delete
function deleteVisitorPersist(encodedApptNo){
  const apptNo = decodeURIComponent(encodedApptNo);
  if(!confirm("Permanently delete visitor "+apptNo+" ? This cannot be undone.")) return;
  const params = new URLSearchParams();
  params.append("action","delete");
  params.append("apptNo", apptNo);
  fetch(SCRIPT_URL, { method: "POST", body: params })
    .then(r=>r.json())
    .then(res=>{
      if(res && res.success){
        // reload table; delete is permanent on sheet
        loadVisitors();
      } else {
        alert("Failed to delete visitor");
      }
    })
    .catch(err=>{
      alert("Error deleting visitor: "+err.message);
    });
}

// Check status (search by appt no) — shows real-time status or Visitor Omitted
function checkStatus(){
  const appt = document.getElementById("statusSearch").value.trim();
  if(!appt){ alert("Please enter your Appointment Number"); return; }
  fetch(SCRIPT_URL + "?appt_no=" + encodeURIComponent(appt))
    .then(r=>r.json())
    .then(data=>{
      const out = document.getElementById("statusResult");
      if(!data || data.error){
        out.innerHTML = "<div style='padding:15px;border-radius:8px;background:white;color:black;'>❌ Visitor Omitted</div>";
        return;
      }
      const status = data.Status || "Pending";
      const cls = (status==="Accepted" || status==="Accept") ? "green" : (status==="Rejected" || status==="Reject") ? "red" : "pink";
      out.innerHTML = `
        <div style="padding:15px;border-radius:8px;background:white;color:black;">
          <p><strong>Appt No:</strong> ${escapeHtml(data["Appointment Number"]||"")}</p>
          <p><strong>Name:</strong> ${escapeHtml(data.Name||"")}</p>
          <p><strong>Visit Date:</strong> ${escapeHtml(data["Visit Date"]||"")}</p>
          <p><strong>Visit Time:</strong> ${escapeHtml((data["Visit Time"]||"").slice(0,5))}</p>
          <p><strong>Status:</strong> <span class="${cls}">${escapeHtml(status)}</span></p>
        </div>
      `;
    })
    .catch(err=>{
      document.getElementById("statusResult").innerHTML = "<div style='padding:15px;border-radius:8px;background:white;color:black;'>❌ Error: "+escapeHtml(err.message)+"</div>";
    });
}

// Print appointment popup (called after submit)
function printAppointmentPopup(resp){
  const w = window.open("", "_blank", "width=700,height=800");
  const now = new Date();
  const submitted = now.getDate().toString().padStart(2,"0")+"-"+(now.getMonth()+1).toString().padStart(2,"0")+"-"+now.getFullYear()+" "+now.getHours().toString().padStart(2,"0")+":"+now.getMinutes().toString().padStart(2,"0");
  const details = resp.details || {}; // some appscripts return details; fallback to form fields
  w.document.write("<html><head><title>Appointment Print</title></head><body>");
  w.document.write("<h2>Appointment Printout</h2>");
  w.document.write("<p><strong>Appointment No:</strong> "+escapeHtml(resp.apptNo || "")+"</p>");
  // include any available returned fields
  for(const k in details){
    if(Object.prototype.hasOwnProperty.call(details,k)){
      w.document.write("<p><strong>"+escapeHtml(k)+":</strong> "+escapeHtml(details[k])+"</p>");
    }
  }
  w.document.write("<p><strong>Submitted:</strong> "+escapeHtml(submitted)+"</p>");
  w.document.write("</body></html>");
  w.document.close();
  w.focus();
  setTimeout(()=>w.print(),250);
}

// small helper to avoid XSS when injecting strings
function escapeHtml(str){
  if(str === null || str === undefined) return "";
  return String(str).replace(/[&<>"']/g, function(m){ return {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]; });
}
</script>
</body>
</html>
